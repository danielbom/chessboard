<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chessboard</title>
    <!-- Global -->
    <style>
      .theme-green {
        --square-light: #eaedcc;
        --square-dark: #70974a;
        /* --move-color: #374a24; */
        /* --move-color: #4a6431; */
        --move-color: #6a593e;
        --protect-color: #536a3e;

        --highlight-light: #f8f970;
        --highlight-dark: #bbce2f;
      }

      body {
        margin: 0;
        background-color: #8b5a2b;
        /* text-align: center; */
        padding: 1rem;
      }

      .invisible {
        visibility: hidden;
      }
    </style>
    <!-- Board -->
    <style>
      /* vars */
      .board {
        --colsize: 90px;
        display: flex;
      }

      .board-white-black {
        flex-direction: column;
      }

      .board-black-white {
        flex-direction: column-reverse;
      }

      /* position */
      .board__row {
        display: flex;
      }
      .board__square {
        position: relative;
      }
      .board__number {
        position: absolute;
        top: 0.15rem;
        left: 0.15rem;
      }
      .board__letter {
        position: absolute;
        bottom: 0.15rem;
        right: 0.15rem;
      }
      .board__attack-defense {
        position: absolute;
        bottom: 0.15rem;
        left: 0.15rem;
      }

      /* sizing */
      .board {
        min-width: calc(var(--colsize) * 8);
      }
      .board__square {
        width: var(--colsize);
        height: var(--colsize);
      }

      /* font */
      .board__attack-defense,
      .board__letter,
      .board__number {
        font-weight: bold;
        font-family: 'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida Sans', Arial, sans-serif;
        font-size: large;
        user-select: none;
        text-transform: uppercase;
      }
      .board__attack-defense {
        font-size: small;
      }

      /* colors */
      .board__square--attacked {
        background: var(--move-color) !important;
      }
      .board__square--protected {
        background: var(--protect-color) !important;
      }

      .board__row:nth-child(odd) .board__square:nth-child(odd),
      .board__row:nth-child(even) .board__square:nth-child(even) {
        background: var(--square-light);
        color: var(--square-dark);
      }
      .board__row:nth-child(odd) .board__square:nth-child(even),
      .board__row:nth-child(even) .board__square:nth-child(odd) {
        background: var(--square-dark);
        color: var(--square-light);
      }
    </style>
    <!-- Board Border -->
    <style>
      .board-border {
        --thickness: 10px;
        --radius: 6px;
        --wood-dark: #6b3f21;
        --wood-c1: #8b5a2b;
        --wood-c2: #a0522d;
        --wood-light: #c3966b;

        display: inline-block;
        padding: var(--thickness);
        border-radius: var(--radius);
        background:
          radial-gradient(circle at top left, var(--wood-light), var(--wood-c1)),
          linear-gradient(135deg, var(--wood-c2) 0%, var(--wood-dark) 100%);
        background-blend-mode: multiply;

        /* subtle highlight, inner shadow, outer shadow */
        box-shadow:
          inset 0 2px 5px rgba(255, 255, 255, 0.3),
          inset 0 -2px 4px rgba(0, 0, 0, 0.3),
          0 6px 16px rgba(0, 0, 0, 0.4);
      }
      .board-border .board {
        border-radius: var(--radius);
        overflow: hidden;
      }
    </style>
    <!-- Pieces -->
    <style>
      /* variables */
      .piece {
        --piece-black: #221d1c;

        --piece-white-a: #f8efe1;
        --piece-white-b: #d3af83;
      }
      /* position */
      .piece {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);

        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center;

        cursor: grab;
      }
      /* sizing */
      .piece {
        border-radius: 100%;
        width: calc(var(--colsize) * 0.8);
        height: calc(var(--colsize) * 0.8);
        overflow: visible;
      }
      /* colors */
      .debug .piece.black {
        background-color: var(--piece-black);
        color: white;
      }
      .debug .piece.white {
        background-color: var(--piece-white-b);
        color: black;
      }
      .piece.black .figure {
        background-color: var(--piece-black);
        color: white;
      }
      .piece.white .figure {
        background: linear-gradient(to right, var(--piece-white-a) 10%, var(--piece-white-b) 33%);
        color: black;
      }

      /* individual pieces */
      .piece.pawn .figure {
        -webkit-mask: url(../v1/pieces/pawn.svg) no-repeat center;
        -webkit-mask-size: cover;
        mask: url(../v1/pieces/pawn.svg) no-repeat center;
        mask-size: cover;
        width: 72%;
        height: 72%;
      }
      .piece.king .figure {
        -webkit-mask: url(../v1/pieces/king.svg) no-repeat center;
        -webkit-mask-size: cover;
        mask: url(../v1/pieces/king.svg) no-repeat center;
        mask-size: cover;
        width: 80%;
        height: 80%;
      }
      .piece.queen .figure {
        -webkit-mask: url(../v1/pieces/queen.svg) no-repeat center;
        -webkit-mask-size: cover;
        mask: url(../v1/pieces/queen.svg) no-repeat center;
        mask-size: cover;
        width: 80%;
        height: 80%;
      }
      .piece.bishop .figure {
        -webkit-mask: url(../v1/pieces/bishop.svg) no-repeat center;
        -webkit-mask-size: cover;
        mask: url(../v1/pieces/bishop.svg) no-repeat center;
        mask-size: cover;
        width: 80%;
        height: 80%;
      }
      .piece.knight .figure {
        -webkit-mask: url(../v1/pieces/knight.svg) no-repeat center;
        -webkit-mask-size: cover;
        mask: url(../v1/pieces/knight.svg) no-repeat center;
        mask-size: cover;
        width: 80%;
        height: 80%;
      }
      .piece.rook .figure {
        -webkit-mask: url(../v1/pieces/rook.svg) no-repeat center;
        -webkit-mask-size: cover;
        mask: url(../v1/pieces/rook.svg) no-repeat center;
        mask-size: cover;
        width: 80%;
        height: 80%;
      }
    </style>
    <!-- Moves -->
    <style>
      /* position */
      .board__move {
        border-radius: 100%;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }
      /* sizing */
      .board__move {
        width: calc(var(--colsize) * 0.33);
        height: calc(var(--colsize) * 0.33);
      }
      /* colors */
      .board__move {
        background-color: var(--move-color);
      }
    </style>
    <!-- Previous move -->
    <style>
      .board__row:nth-child(odd) .board__previous-move:nth-child(odd),
      .board__row:nth-child(even) .board__previous-move:nth-child(even) {
        background: var(--highlight-light);
        color: var(--highlight-dark);
      }
      .board__row:nth-child(odd) .board__previous-move:nth-child(even),
      .board__row:nth-child(even) .board__previous-move:nth-child(odd) {
        background: var(--highlight-dark);
        color: var(--highlight-light);
      }
    </style>
    <!-- Tools + Button -->
    <style>
      .tools {
        padding: 12px 0;
        gap: 10px;
        display: flex;
        flex-wrap: wrap;
      }

      .button {
        padding: 0.5em 1.5em;
        border: none;
        border-radius: 1.5em;
        background: #4a6431;
        color: #fff;
        font-size: 1.1em;
        font-weight: bold;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.18);
        cursor: pointer;
        transition: background 0.2s;
      }
      .button:hover {
        background: #6a593e;
      }
    </style>
    <!-- Stats  -->
    <style>
      .stats {
        color: white;
        padding: 1rem 0 0.5rem 1rem;
        display: flex;
        gap: 3rem;
        font-size: 1.35rem;
      }
    </style>
  </head>
  <body class="nodebug">
    <div class="theme-green">
      <div class="board-border">
        <div class="board board-white-black">
          <div class="board__row">
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <span class="board__number">8</span>
              <div class="board__move"></div>
              <div class="piece black rook">
                <div class="figure"></div>
              </div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
              <div class="piece black knight">
                <div class="figure"></div>
              </div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
              <div class="piece black bishop">
                <div class="figure"></div>
              </div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
              <div class="piece black queen">
                <div class="figure"></div>
              </div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
              <div class="piece black king">
                <div class="figure"></div>
              </div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
              <div class="piece black bishop">
                <div class="figure"></div>
              </div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
              <div class="piece black knight">
                <div class="figure"></div>
              </div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
              <div class="piece black rook">
                <div class="figure"></div>
              </div>
            </div>
          </div>
          <div class="board__row">
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <span class="board__number">7</span>
              <div class="board__move"></div>
              <div class="piece black pawn">
                <div class="figure"></div>
              </div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
              <div class="piece black pawn">
                <div class="figure"></div>
              </div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
              <div class="piece black pawn">
                <div class="figure"></div>
              </div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
              <div class="piece black pawn">
                <div class="figure"></div>
              </div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
              <div class="piece black pawn">
                <div class="figure"></div>
              </div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
              <div class="piece black pawn">
                <div class="figure"></div>
              </div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
              <div class="piece black pawn">
                <div class="figure"></div>
              </div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
              <div class="piece black pawn">
                <div class="figure"></div>
              </div>
            </div>
          </div>
          <div class="board__row">
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <span class="board__number">6</span>
              <div class="board__move"></div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
            </div>
          </div>
          <div class="board__row">
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <span class="board__number">5</span>
              <div class="board__move"></div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
            </div>
          </div>
          <div class="board__row">
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <span class="board__number">4</span>
              <div class="board__move"></div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
            </div>
          </div>
          <div class="board__row">
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <span class="board__number">3</span>
              <div class="board__move"></div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
            </div>
          </div>
          <div class="board__row">
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <span class="board__number">2</span>
              <div class="board__move"></div>
              <div class="piece white pawn">
                <div class="figure"></div>
              </div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
              <div class="piece white pawn">
                <div class="figure"></div>
              </div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
              <div class="piece white pawn">
                <div class="figure"></div>
              </div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
              <div class="piece white pawn">
                <div class="figure"></div>
              </div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
              <div class="piece white pawn">
                <div class="figure"></div>
              </div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
              <div class="piece white pawn">
                <div class="figure"></div>
              </div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
              <div class="piece white pawn">
                <div class="figure"></div>
              </div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <div class="board__move"></div>
              <div class="piece white pawn">
                <div class="figure"></div>
              </div>
            </div>
          </div>
          <div class="board__row">
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <span class="board__number">1</span>
              <span class="board__letter">a</span>
              <div class="board__move"></div>
              <div class="piece white rook">
                <div class="figure"></div>
              </div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <span class="board__letter">b</span>
              <div class="board__move"></div>
              <div class="piece white knight">
                <div class="figure"></div>
              </div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <span class="board__letter">c</span>
              <div class="board__move"></div>
              <div class="piece white bishop">
                <div class="figure"></div>
              </div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <span class="board__letter">d</span>
              <div class="board__move"></div>
              <div class="piece white queen">
                <div class="figure"></div>
              </div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <span class="board__letter">e</span>
              <div class="board__move"></div>
              <div class="piece white king">
                <div class="figure"></div>
              </div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <span class="board__letter">f</span>
              <div class="board__move"></div>
              <div class="piece white bishop">
                <div class="figure"></div>
              </div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <span class="board__letter">g</span>
              <div class="board__move"></div>
              <div class="piece white knight">
                <div class="figure"></div>
              </div>
            </div>
            <div class="board__square">
              <span class="board__attack-defense">0/0</span>
              <span class="board__letter">h</span>
              <div class="board__move"></div>
              <div class="piece white rook">
                <div class="figure"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="stats">
        <div>
          White Pieces:
          <span id="stats-pieces-white">0</span>
        </div>
        <div>
          Black Pieces:
          <span id="stats-pieces-black">0</span>
        </div>
        <div>
          White Points:
          <span id="stats-points-white">0</span>
        </div>
        <div>
          Black Points:
          <span id="stats-points-black">0</span>
        </div>
      </div>
      <div class="tools">
        <button type="button" id="tool-loadGame" class="button">Load game</button>
        <button type="button" id="tool-reset" class="button">Reset</button>
        <button type="button" id="tool-previous" class="button">Previous</button>
        <button type="button" id="tool-next" class="button">Next</button>
        <button type="button" id="tool-swap-view" class="button">Swap View</button>
        <button type="button" id="tool-put-piece" class="button">Put Piece</button>
      </div>
    </div>
  </body>

  <!-- Utilities -->
  <script>
    /**
     * @params {Record<string, string>} record
     * @returns {Record<string, string>}
     */
    function reverseRecord(record) {
      return Object.fromEntries(Object.entries(record).map(([key, value]) => [value, key]))
    }
  </script>

  <!-- Set pieces attributes -->
  <script>
    // DATA SET
    const PIECES_COLORS = ['black', 'white']
    const PIECES_NAMES = ['rook', 'knight', 'bishop', 'queen', 'king', 'pawn']
    const PIECES_SIMBOL = { r: 'rook', k: 'knight', b: 'bishop', Q: 'queen', K: 'king', p: 'pawn' }
    const PIECES_POINTS = { r: 5, k: 3, b: 4, Q: 10, K: 0, p: 1 }
    document.querySelectorAll('.board__square').forEach((el, index) => {
      el.setAttribute('data-row', `${Math.floor(index / 8)}`)
      el.setAttribute('data-col', `${index % 8}`)
      el.setAttribute('id', `square-#${index}`)
    })

    let piecesIds = 0
    document.querySelectorAll('.piece').forEach((el) => {
      const pieceName = PIECES_NAMES.find((it) => el.classList.contains(it))
      if (!pieceName) throw new Error()
      const pieceColor = PIECES_COLORS.find((it) => el.classList.contains(it))
      if (!pieceColor) throw new Error()
      el.setAttribute('draggable', 'true')
      el.setAttribute('id', `piece-#${++piecesIds}`)
      el.setAttribute('data-name', pieceName)
      el.setAttribute('data-color', pieceColor)
    })
  </script>

  <!-- Startup initial UI state -->
  <script>
    document.querySelectorAll('.board__move').forEach((el) => {
      el.classList.add('invisible')
    })
    document.querySelectorAll('.board__attack-defense').forEach((el) => {
      el.classList.add('invisible')
    })
  </script>

  <!-- Chess Moves -->
  <script>
    /**
     * @typedef {Object} ChessBoardView
     * @property {(y: number, x: number) => string | undefined} get
     */

    class ChessMoves {
      constructor(/** @type {ChessBoardView} */ view) {
        /** @type {ChessBoardView} */
        this.view = view

        this.bishop = [
          [-1, -1],
          [-1, +1],
          [+1, -1],
          [+1, +1],
        ]
        this.rook = [
          [-1, 0],
          [0, -1],
          [0, +1],
          [+1, 0],
        ]
        this.knight = [
          [1, 2],
          [2, 1],
          [-1, 2],
          [-2, 1],
          [1, -2],
          [2, -1],
          [-1, 2],
          [2, -1],
          [1, -2],
          [-2, 1],
          [-1, -2],
          [-2, -1],
        ]
      }

      /**
       * @param {number} y
       * @param {number} x
       * @returns {string}
       */
      getPiece(y, x) {
        const piece = this.view.get(y, x)
        if (!piece) return
        if (piece === '  ') return
        return piece
      }

      _getHelpers(piece) {
        /** @type {[number, number][]} */
        const result = []
        const protectable = (y, x) => this.getPiece(y, x)?.endsWith(piece[1]) === true
        const capturable = (y, x) => this.getPiece(y, x)?.endsWith(piece[1]) === false
        const canMove = (y, x) => this.view.get(y, x) === '  '
        const move = (y, x) => canMove(y, x) && (result.push([y, x]), true)
        const capture = (y, x) => capturable(y, x) && (result.push([y, x]), true)
        const protect = (y, x) => protectable(y, x) && (result.push([y, x]), true)
        return {
          canMove,
          move,
          capture,
          protect,
          result,
        }
      }

      /**
       * @param {number} y
       * @param {number} x
       * @returns {[number, number][]}
       */
      _getOccupations(y, x, kind) {
        const piece = this.getPiece(y, x)
        if (!piece) return
        const { protect, capture, canMove, result } = this._getHelpers(piece)
        const move = { protect, capture }[kind]
        if (!move) throw new Error(kind)

        switch (piece[0]) {
          case 'p': {
            const doubleRow = piece[1] === 'b' ? 1 : 6
            const dir = piece[1] === 'b' ? 1 : -1
            move(y + 1 * dir, x - 1)
            move(y + 1 * dir, x + 1)
            return result
          }
          case 'K': {
            this.bishop.forEach(([j, i]) => move(y + j, x + i))
            this.rook.forEach(([j, i]) => move(y + j, x + i))
            return result
          }
          case 'Q': {
            this.rook.forEach(([j, i]) => {
              let k = 1
              for (; k < 8; k++) {
                if (!canMove(y + j * k, x + i * k)) break
              }
              move(y + j * k, x + i * k)
            })
            this.bishop.forEach(([j, i]) => {
              let k = 1
              for (; k < 8; k++) {
                if (!canMove(y + j * k, x + i * k)) break
              }
              move(y + j * k, x + i * k)
            })
            return result
          }
          case 'r': {
            this.rook.forEach(([j, i]) => {
              let k = 1
              for (; k < 8; k++) {
                if (!canMove(y + j * k, x + i * k)) break
              }
              move(y + j * k, x + i * k)
            })
            return result
          }
          case 'b': {
            this.bishop.forEach(([j, i]) => {
              let k = 1
              for (; k < 8; k++) {
                if (!canMove(y + j * k, x + i * k)) break
              }
              move(y + j * k, x + i * k)
            })
            return result
          }
          case 'k': {
            this.knight.forEach(([j, i]) => {
              move(y + j, x + i)
            })
            return result
          }
        }
        return result
      }

      /**
       * @param {number} y
       * @param {number} x
       * @returns {[number, number][]}
       */
      getCaptures(y, x) {
        return this._getOccupations(y, x, 'capture')
      }

      /**
       * @param {number} y
       * @param {number} x
       * @returns {[number, number][]}
       */
      getProtects(y, x) {
        return this._getOccupations(y, x, 'protect')
      }

      /**
       * @param {number} y
       * @param {number} x
       * @returns {[number, number][]}
       */
      getMoves(y, x) {
        const piece = this.getPiece(y, x)
        if (!piece) return
        const { move, result } = this._getHelpers(piece)

        switch (piece[0]) {
          case 'p': {
            const doubleRow = piece[1] === 'b' ? 1 : 6
            const dir = piece[1] === 'b' ? 1 : -1
            if (!move(y + 1 * dir, x)) return result
            if (doubleRow === y && !move(y + 2 * dir, x)) return result
            return result
          }
          case 'K': {
            this.bishop.forEach(([j, i]) => move(y + j, x + i))
            this.rook.forEach(([j, i]) => move(y + j, x + i))
            return result
          }
          case 'Q': {
            this.rook.forEach(([j, i]) => {
              let k = 1
              for (; k < 8; k++) {
                if (!move(y + j * k, x + i * k)) break
              }
            })
            this.bishop.forEach(([j, i]) => {
              let k = 1
              for (; k < 8; k++) {
                if (!move(y + j * k, x + i * k)) break
              }
            })
            return result
          }
          case 'r': {
            this.rook.forEach(([j, i]) => {
              let k = 1
              for (; k < 8; k++) {
                if (!move(y + j * k, x + i * k)) break
              }
            })
            return result
          }
          case 'b': {
            this.bishop.forEach(([j, i]) => {
              let k = 1
              for (; k < 8; k++) {
                if (!move(y + j * k, x + i * k)) break
              }
            })
            return result
          }
          case 'k': {
            this.knight.forEach(([j, i]) => {
              move(y + j, x + i)
            })
            return result
          }
        }
        return result
      }
    }
  </script>

  <!-- TODO: Chess State -->
  <script>
    class ChessState {
      constructor(/** @type {ChessBoardView} */ view) {
        throw new Error('TODO: ChessState')
        this.view = view
        this.currentPlayer = 'white'
        this.nextPlayer = 'black'
        this.castling = {
          white: true,
          black: true,
        }
      }

      swapPlayers() {
        const player = this.currentPlayer
        this.currentPlayer = this.nextPlayer
        this.nextPlayer = player
      }
    }
  </script>

  <!-- Actions -->
  <script>
    // @ts-check
    /** @typedef {{ kind: 'move', y1: number, x1: number, y2: number, x2: number }} MovePiece */
    /** @typedef {{ kind: 'put', pieceName: string, pieceColor: string, y: number, x: number }} PutPiece */
    /** @typedef {MovePiece | PutPiece} Move */

    /** @typedef {{ readonly name: 'previous' }} PreviousAction */
    /** @typedef {{ readonly name: 'next' }} NextAction */
    /** @typedef {{ readonly name: 'reset' }} ResetAction */
    /** @typedef {{ readonly name: 'swap-view' }} SwapViewAction */
    /** @typedef {{ readonly name: 'set-moves', moves: Array<Move> }} SetMovesAction */
    /** @typedef {{ readonly name: 'square-click', square: HTMLElement }} ClickSquareAction */
    /** @typedef {{ readonly name: 'piece-click', piece: HTMLElement }} ClickPieceAction */
    /** @typedef {{ readonly name: 'move-relative', move: Move }} MoveRelativeAction */
    /** @typedef {{ readonly name: 'move', piece: HTMLElement, to: HTMLElement }} MoveAction */
    /** @typedef {{ readonly name: 'put-piece', pieceName: string, pieceColor: string, x: number, y: string }} PutPieceAction */

    const act = {
      /** @returns {PreviousAction} */
      previous: () => ({ name: 'previous' }),
      /** @returns {NextAction} */
      next: () => ({ name: 'next' }),
      /** @returns {ResetAction} */
      reset: () => ({ name: 'reset' }),
      /** @returns {SwapViewAction} */
      swapDictions: () => ({ name: 'swap-view' }),
      /**
       * @param {Array<Move>} moves
       * @returns {SetMovesAction}
       */
      setMoves: (moves) => ({ name: 'set-moves', moves }),
      /**
       * @param {HTMLElement} square
       * @returns {ClickSquareAction}
       */
      squareClicked: (square) => ({ name: 'square-click', square }),
      /**
       * @param {HTMLElement} piece
       * @returns {ClickPieceAction}
       */
      pieceClicked: (piece) => ({ name: 'piece-click', piece }),
      /**
       * @param {Move} move
       * @returns {MoveRelativeAction}
       */
      moveRelative: (move) => ({ name: 'move-relative', move }),
      /**
       * @param {HTMLElement} piece
       * @param {HTMLElement} to
       * @returns {MoveAction}
       */
      move: (piece, to) => ({ name: 'move', piece, to }),
      /**
       * @param {string} pieceName
       * @param {string} pieceColor
       * @param {number} y
       * @param {number} x
       * @returns {PutPieceAction}
       */
      putPiece: (pieceName, pieceColor, y, x) => ({ name: 'put-piece', pieceName, pieceColor, y, x }),
    }

    /**
     * @typedef {PreviousAction | NextAction | ResetAction | SetMovesAction | ClickSquareAction | ClickPieceAction | MoveRelativeAction | MoveAction} Action
     */
  </script>

  <!-- Board View -->
  <script>
    const DEFAULT_BOARD = document.querySelector('.board').cloneNode(true)
    const PIECES_MAP = Object.fromEntries(
      Array.from(document.querySelectorAll('.piece'), (el) => [Array.from(el.classList).join('.'), el.cloneNode(true)]),
    )

    class BoardState {
      constructor(/** @type {string[][]} */ board) {
        this.board = board
      }

      get(/** @type {number} */ y, /** @type {number} */ x) {
        if (0 <= y && y < this.board.length && 0 <= x && x < this.board.length) {
          return this.board[y][x]
        }
      }

      getStats() {
        const result = {
          white: {
            pieces: 0,
            points: 0,
          },
          black: {
            pieces: 0,
            points: 0,
          },
        }
        this.board.forEach((row) => {
          row.forEach((piece) => {
            let color = piece[1] === 'b' ? 'black' : piece[1] === 'w' ? 'white' : ''
            if (color) {
              result[color].pieces++
              result[color].points += PIECES_POINTS[piece[0]]
            }
          })
        })
        return result
      }
    }

    class BoardView {
      constructor() {
        /** @type {Array<(event: MoveEvent) => void>} */
        this.callbacks = []
        /** @type {Record<string, HTMLElement | undefined>} */
        this.ids = {}
        this.putPieceId = 1
      }

      _addEventToPiece(el) {
        el.addEventListener('dragstart', (e) => {
          e.dataTransfer.setData('text/plain', el.getAttribute('id'))
          this.emit(act.pieceClicked(el))
        })

        el.addEventListener('click', () => {
          this.emit(act.pieceClicked(el))
        })
      }

      startup() {
        // reset the board
        const board = document.querySelector('.board')
        board.innerHTML = DEFAULT_BOARD.innerHTML

        document.querySelectorAll('.piece').forEach((el) => this._addEventToPiece(el))

        document.querySelectorAll('.board__square').forEach((to) => {
          to.addEventListener('dragover', (e) => {
            e.preventDefault() // allows drop
          })
          to.addEventListener('drop', (e) => {
            e.preventDefault()
            const id = e.dataTransfer.getData('text/plain')
            const piece = document.getElementById(id)
            const [y1, x1] = boardView.getSquarePosition(piece.parentNode)
            const [y2, x2] = boardView.getSquarePosition(to)
            this.emit(act.moveRelative({ y1, x1, y2, x2 }))
          })
          to.addEventListener('click', (e) => {
            this.emit(act.squareClicked(to))
          })
        })

        document.querySelectorAll('.board__square').forEach((square) => {
          const pos = boardView.getSquarePosition(square)
          this.ids[pos] = square.getAttribute('id')
        })
      }

      emit(/** @type {Action} */ event) {
        this.callbacks.forEach((callback) => callback(event))
      }

      subscribe(callback) {
        this.callbacks.push(callback)
      }

      getState() {
        const reversePiecesSimbols = reverseRecord(PIECES_SIMBOL)
        const board = Array.from({ length: 8 }, () => Array.from({ length: 8 }, () => '  '))
        document.querySelectorAll('.piece').forEach((el) => {
          const pieceName = el.getAttribute('data-name')
          const pieceColor = el.getAttribute('data-color')
          const y = +el.parentNode.getAttribute('data-row')
          const x = +el.parentNode.getAttribute('data-col')
          board[y][x] = reversePiecesSimbols[pieceName] + pieceColor[0]
        })
        return new BoardState(board)
      }

      /**
       * @param {string} pieceName
       * @param {string} pieceColor
       * @param {HTMLElement} squareElement
       */
      putPiece(pieceName, pieceColor, squareElement) {
        const pieceId = `piece.${pieceColor}.${pieceName}`
        const pieceElement = PIECES_MAP[pieceId]?.cloneNode(true)
        if (!pieceElement) throw new Error()
        this._addEventToPiece(pieceElement)
        pieceElement.setAttribute('id', `piece-put-#${++this.putPieceId}`)
        this.move(pieceElement, squareElement)
      }

      move(/** @type {HTMLElement} */ piece, /** @type {HTMLElement} */ to) {
        to.querySelectorAll('.piece').forEach((el) => {
          to.removeChild(el)
        })
        to.appendChild(piece)
      }

      getSquare(/** @type {number} */ y, /** @type {number} */ x) {
        const id = this.ids[[y, x]]
        if (!id) return null
        return document.getElementById(id)
      }

      getSquarePiece(/** @type {HTMLElement} */ square) {
        return square.querySelector('.piece')
      }

      getPiece(/** @type {number} */ y, /** @type {number} */ x) {
        const square = this.getSquare(y, x)
        if (!square) return null
        return this.getSquarePiece(square)
      }

      clearMoves() {
        document.querySelectorAll('.board__move').forEach((el) => {
          el.classList.add('invisible')
        })
        document.querySelectorAll('.board__square--attacked').forEach((el) => {
          el.classList.remove('board__square--attacked')
        })
        document.querySelectorAll('.board__square--protected').forEach((el) => {
          el.classList.remove('board__square--protected')
        })
      }

      showMoves(/** @type {number} */ y, /** @type {number} */ x) {
        const chessMoves = new ChessMoves(boardView.getState())
        const possibleMoves = new Set(chessMoves.getMoves(y, x).map((it) => it.toString()))
        const possibleCaptures = new Set(chessMoves.getCaptures(y, x).map((it) => it.toString()))
        const possibleProtects = new Set(chessMoves.getProtects(y, x).map((it) => it.toString()))
        document.querySelectorAll('.board__square--attacked').forEach((el) => {
          el.classList.remove('board__square--attacked')
        })
        document.querySelectorAll('.board__square--protected').forEach((el) => {
          el.classList.remove('board__square--protected')
        })
        document.querySelectorAll('.board__move').forEach((el) => {
          const square = el.parentNode
          const pos = boardView.getSquarePosition(square).toString()
          if (possibleMoves.has(pos)) {
            el.classList.remove('invisible')
          } else {
            el.classList.add('invisible')
          }
          if (possibleCaptures.has(pos) && this.getSquarePiece(square)) {
            square.classList.add('board__square--attacked')
          }
          if (possibleProtects.has(pos) && this.getSquarePiece(square)) {
            square.classList.add('board__square--protected')
          }
        })
        return possibleMoves.size > 0 || possibleCaptures.size > 0 || possibleProtects.size > 0
      }

      equals(/** @type {HTMLElement} */ a, /** @type {HTMLElement} */ b) {
        return a.getAttribute('id') === b.getAttribute('id')
      }

      getSquarePosition(/** @type {HTMLElement} */ square) {
        return [+square.getAttribute('data-row'), +square.getAttribute('data-col')]
      }

      getPiecePosition(/** @type {HTMLElement} */ piece) {
        return this.getSquarePosition(piece.parentNode)
      }

      highlightMove(/** @type {Move} */ move) {
        if (move.kind === 'move') {
          const { y1, x1, y2, x2 } = move
          this.getSquare(y1, x1).classList.add('board__previous-move')
          this.getSquare(y2, x2).classList.add('board__previous-move')
        }
      }

      clearPreviousMove() {
        document.querySelectorAll('.board__previous-move').forEach((el) => {
          el.classList.remove('board__previous-move')
        })
      }
    }

    const boardView = new BoardView()
    boardView.startup()
  </script>

  <!-- App Reducer -->
  <script>
    /**
     * @typedef {Object} State
     * @property {HTMLElement | null} previousPiece
     * @property {Array<Move>} moves
     * @property {number} current
     * @property {string} currentDirection
     * @property {string} nextDirection
     */
    const SWAP_VIEW = 'swap-view'

    class App {
      static letters = Array.from('abcdefgh').reverse()

      constructor() {
        /** @type {State} */
        this.state = {
          previousPiece: null,
          moves: [],
          current: 0,
          currentDirection: 'board-white-black',
          nextDirection: 'board-black-white',
        }
      }

      startup() {
        boardView.subscribe((event) => this.dispatch(event))

        document.getElementById('tool-reset').addEventListener('click', () => this.reset())

        document.getElementById('tool-swap-view').addEventListener('click', () => this.swapDirections())

        document.getElementById('tool-put-piece').addEventListener('click', () => this.putPiece())

        document.getElementById('tool-loadGame').addEventListener('click', () => {
          const index = prompt('Game index').padStart(3, '0')
          if (index !== '000') {
            this.loadGame(`./games/${index}.txt`).catch((error) => {
              console.error('Error loading file:', error)
            })
          }
        })

        document.getElementById('tool-next').addEventListener('click', () => {
          this.dispatch(act.next())
        })

        document.getElementById('tool-previous').addEventListener('click', () => {
          this.dispatch(act.previous())
        })

        if (localStorage.getItem(SWAP_VIEW) === this.state.nextDirection) {
          this.swapDirections()
        }

        this.updateStats()

        this.loadGame('./games/003.txt').then(() => {
          this.state.moves.forEach(() => app.dispatch(act.next()))
          console.error('complete')
        })
      }

      swapDirections() {
        const board = document.querySelector('.board')
        board.classList.remove(this.state.currentDirection)
        board.classList.add(this.state.nextDirection)
        localStorage.setItem(SWAP_VIEW, this.state.nextDirection)
        this.dispatch(act.swapDictions())
      }

      reset() {
        boardView.startup()
        this.dispatch(act.reset())
        this.updateStats()
      }

      updateStats() {
        const stats = boardView.getState().getStats()
        document.getElementById('stats-pieces-white').innerText = stats.white.pieces
        document.getElementById('stats-pieces-black').innerText = stats.black.pieces
        document.getElementById('stats-points-white').innerText = stats.white.points
        document.getElementById('stats-points-black').innerText = stats.black.points
      }

      putPiece() {
        const chessLetters = Array.from('abcdefgh')
        const chessNumbers = Array.from('12345678').reverse()
        const square = window.prompt('Enter the square')
        const x = chessLetters.indexOf(square[0])
        const y = chessNumbers.indexOf(square[1])
        if (y === -1 || x === -1) return window.alert(`Square ${square} not found`)

        const color = window.prompt('Enter the color')
        const colorLower = color?.toLowerCase()
        const pieceColor = colorLower[0] === 'b' ? 'black' : colorLower[0] === 'w' ? 'white' : undefined
        if (!pieceColor) return window.alert(`Invalid color ${color}`)

        const name = window.prompt('Enter the piece name')
        const nameLower = name?.toLowerCase()
        const pieceName = name ? PIECES_SIMBOL[name[0]] || PIECES_NAMES.find((name) => nameLower === name) : undefined
        if (!pieceColor) return window.alert(`Invalid name ${name}`)

        this.dispatch(act.putPiece(pieceName, pieceColor, y, x))
      }

      /**
       * @param {string} content
       */
      parseGame(content) {
        // BUG: chessLetters & chessNumbers are inverted
        const chessLetters = Array.from('abcdefgh').reverse()
        const chessNumbers = Array.from('12345678')
        const lines = content
          .split('\n')
          .map((it) => it.trim())
          .filter((it) => it.length > 0)
          .reverse()
        if (lines.length === 0) return []
        const result = []
        while (lines.length > 0) {
          const line = lines.pop()
          if (line.startsWith('*')) continue
          if (line.startsWith('-')) break
          if (line.startsWith('put:')) {
            const [_, pieceName, pieceColor, position] = line.split(/\s+/)
            result.push({
              kind: 'put',
              pieceName,
              pieceColor,
              y: chessLetters.indexOf(position[0]),
              x: chessNumbers.indexOf(position[1]),
            })
          } else {
            const play = line.split(':')
            if (play.length !== 2) continue
            result.push({
              kind: 'move',
              y1: chessLetters.indexOf(play[0][0]),
              x1: chessNumbers.indexOf(play[0][1]),
              y2: chessLetters.indexOf(play[1][0]),
              x2: chessNumbers.indexOf(play[1][1]),
            })
          }
        }
        return result
      }

      async loadGame(game) {
        const response = await fetch(game)
        const text = await response.text()
        const moves = this.parseGame(text)
        app.dispatch(act.setMoves(moves))
      }

      applyMove(move) {
        switch (move.kind) {
          case 'move': {
            const { y1, x1, y2, x2 } = move
            const to = boardView.getSquare(y2, x2)
            const piece = boardView.getPiece(y1, x1)
            if (piece && to) {
              console.log(`${App.letters[y1]}${x1 + 1}:${App.letters[y2]}${x2 + 1}`)
              boardView.move(piece, to)
              this.updateStats()
              return true
            } else {
              console.log(`INVALID MOVE: ${App.letters[y1]}${x1 + 1}:${App.letters[y2]}${x2 + 1}`)
            }
            return false
          }
          case 'put': {
            const { pieceName, pieceColor, y, x } = move
            const squareElement = boardView.getSquare(y, x)
            if (squareElement && PIECES_NAMES.includes(pieceName) && PIECES_COLORS.includes(pieceColor)) {
              console.log(`put: ${pieceName} ${pieceColor} ${App.letters[y]}${x + 1}`)
              boardView.putPiece(pieceName, pieceColor, squareElement)
              return true
            } else {
              console.log(`INVALID PUT PIECE: ${pieceName} ${pieceColor} ${App.letters[y]}${x + 1}`)
              return false
            }
          }
        }
      }

      /**
       * @param {State} state
       * @param {Action} action
       * @returns {State}
       */
      reducer(state, action) {
        if (false) console.count(`reducer: ${action.name}`)

        switch (action.name) {
          case 'swap-view': {
            const direction = state.currentDirection
            return { ...state, currentDirection: state.nextDirection, nextDirection: state.currentDirection }
          }
          case 'set-moves': {
            return { ...state, moves: action.moves }
          }
          case 'previous': {
            if (this.state.current > 0) {
              const current = this.state.current - 1
              boardView.startup()
              for (let index = 0; index < current; index++) {
                this.applyMove(this.state.moves[index])
              }
              boardView.highlightMove(this.state.moves[current])
              return { ...state, current }
            }
            return state
          }
          case 'next': {
            if (this.state.current < this.state.moves.length) {
              const move = this.state.moves[this.state.current]
              return this.reducer({ ...state, current: this.state.current + 1 }, act.moveRelative(move))
            }
            return state
          }
          case 'reset': {
            return { ...state, current: 0, previousPiece: null }
          }
          case 'move': {
            const [y1, x1] = boardView.getPiecePosition(action.piece)
            const [y2, x2] = boardView.getSquarePosition(action.to)
            return this.reducer(state, act.moveRelative({ kind: 'move', y1, x1, y2, x2 }))
          }
          case 'move-relative': {
            if (this.applyMove(action.move)) {
              boardView.clearPreviousMove()
              boardView.clearMoves()
              boardView.highlightMove(action.move)
              return { ...state, previousPiece: null }
            }
            return state
          }
          case 'piece-click': {
            const square = action.piece.parentNode
            if (state.previousPiece) {
              if (boardView.equals(action.piece, state.previousPiece)) {
                boardView.clearMoves()
                return { ...state, previousPiece: null }
              }
              return this.reducer(state, act.move(state.previousPiece, square))
            }
            const [y, x] = boardView.getSquarePosition(square)
            if (boardView.showMoves(y, x)) {
              return { ...state, previousPiece: action.piece }
            } else {
              return state
            }
          }
          case 'square-click': {
            if (!state.previousPiece) return state
            const piece = boardView.getSquarePiece(action.square)
            if (piece && boardView.equals(piece, state.previousPiece)) return state
            return this.reducer(state, act.move(state.previousPiece, action.square))
          }
          case 'put-piece': {
            return this.reducer(state, act.moveRelative({ kind: 'put-piece', ...action }))
          }
        }
        return state
      }

      dispatch(action) {
        this.state = this.reducer(this.state, action)
      }
    }

    const app = new App()
    app.startup()
  </script>
</html>
